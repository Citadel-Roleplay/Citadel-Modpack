namespace = agot_slavery

agot_slavery.0001 = {
	hidden = yes

	immediate = {
		if = {
			limit = { has_realm_law = slavery_allowed_law }
			add_trait = slave_master

			if = {
				limit = {
					OR = {
						has_title = title:k_braavos
						has_title = title:d_braavos
						has_title = title:c_braavos
					}
				}
			}
			save_scope_as = slaver
			title:c_ruins.holder = {
				trigger_event = {
					id = agot_slavery.0100
					days = { 30 60 }
				}
			}
		}
		else = {
			remove_realm_slave_population_effect = yes
		}
	}
}

agot_slavery.0100 = {
	hidden = yes

	trigger ={
		scope:slaver = {
			OR = {
				has_title = title:k_braavos
				has_title = title:d_braavos
				has_title = title:c_braavos
			}
			has_realm_law = slavery_allowed_law
		}
	}

	immediate = {
		agot_faceless_use_face_random = yes
		scope:faceless_man = {
			set_location = {
				location = scope:slaver.location
				stick_to_location = yes
			}
		}

		scope:slaver = {
			trigger_event = agot_slavery.0101
		}
	}
}

agot_slavery.0101 = {
	type = character_event
	title = agot_slavery.0101.t
	desc = agot_slavery.0101.desc

	theme = murder_scheme
	override_background = { reference = council_chamber }

	left_portrait = {
		character = root
		animation = fear
	}
	right_portrait = {
		character = scope:faceless_man
		animation = assassin
	}

	option = {
		name = agot_slavery.0101.a
		hidden_effect = {
			add_realm_law_skip_effects = slavery_disallowed_law
		}
		death = {
			death_reason = death_murder
			killer = scope:faceless_man
		}
	}

	after = {
		scope:faceless_man = {
			silent_disappearance_effect = yes
		}
	}
}

#Send slave raid slave population to increase valid population
agot_slavery.9001 = {
	type = character_event
	title = agot_slavery.9001.t
	desc = agot_slavery.9001.desc

	theme = prison
	right_portrait = {
		character = root
		animation = personality_dishonorable
	}

	immediate = {
		if = {
			limit = {
				capital_province.barony = { agot_can_upgrade_slave_population_trigger = yes }
			}
			capital_province.barony = { save_scope_as = option_1 }
		}
		else = {
			random_held_title = {
				limit = {
					tier = tier_barony
					agot_can_upgrade_slave_population_trigger = yes
				}
				save_scope_as = option_1
			}
		}

		if = {
			limit = {
				any_held_title = {
					tier = tier_barony
					agot_can_upgrade_slave_population_trigger = yes
					NOT = { this = scope:option_1 }
				}
			}
			random_held_title = {
				limit = {
					tier = tier_barony
					agot_can_upgrade_slave_population_trigger = yes
					NOT = { this = scope:option_1 }
				}
				save_scope_as = option_2
			}
		}

		if = {
			limit = {
				any_held_title = {
					tier = tier_barony
					agot_can_upgrade_slave_population_trigger = yes
					NOT = { this = scope:option_1 }
					NOT = { this = scope:option_2 }
				}
			}
			random_held_title = {
				limit = {
					tier = tier_barony
					agot_can_upgrade_slave_population_trigger = yes
					NOT = { this = scope:option_1 }
					NOT = { this = scope:option_2 }
				}
				save_scope_as = option_3
			}
		}

		if = {
			limit = {
				any_held_title = {
					tier = tier_barony
					agot_can_upgrade_slave_population_trigger = yes
					NOT = { this = scope:option_1 }
					NOT = { this = scope:option_2 }
					NOT = { this = scope:option_3 }
				}
			}
			random_held_title = {
				limit = {
					tier = tier_barony
					agot_can_upgrade_slave_population_trigger = yes
					NOT = { this = scope:option_1 }
					NOT = { this = scope:option_2 }
					NOT = { this = scope:option_3 }
				}
				save_scope_as = option_4
			}
		}

		if = {
			limit = {
				any_held_title = {
					tier = tier_barony
					agot_can_upgrade_slave_population_trigger = yes
					NOT = { this = scope:option_1 }
					NOT = { this = scope:option_2 }
					NOT = { this = scope:option_3 }
					NOT = { this = scope:option_4 }
				}
			}
			random_held_title = {
				limit = {
					tier = tier_barony
					agot_can_upgrade_slave_population_trigger = yes
					NOT = { this = scope:option_1 }
					NOT = { this = scope:option_2 }
					NOT = { this = scope:option_3 }
					NOT = { this = scope:option_4 }
				}
				save_scope_as = option_5
			}
		}

		if = {
			limit = {
				any_held_title = {
					tier = tier_barony
					agot_can_upgrade_slave_population_trigger = yes
					NOT = { this = scope:option_1 }
					NOT = { this = scope:option_2 }
					NOT = { this = scope:option_3 }
					NOT = { this = scope:option_4 }
					NOT = { this = scope:option_5 }
				}
			}
			random_held_title = {
				limit = {
					tier = tier_barony
					agot_can_upgrade_slave_population_trigger = yes
					NOT = { this = scope:option_1 }
					NOT = { this = scope:option_2 }
					NOT = { this = scope:option_3 }
					NOT = { this = scope:option_4 }
					NOT = { this = scope:option_5 }
				}
				save_scope_as = option_6
			}
		}
	}

	option = {
		name = agot_slavery.9001.a
		scope:option_1.county = { upgrade_slave_population_effect = yes }
	}

	option = {
		trigger = { exists = scope:option_2 }
		name = agot_slavery.9001.b
		scope:option_2.county = { upgrade_slave_population_effect = yes }
	}

	option = {
		trigger = { exists = scope:option_3 }
		name = agot_slavery.9001.c
		scope:option_3.county = { upgrade_slave_population_effect = yes }
	}

	option = {
		trigger = { exists = scope:option_4 }
		name = agot_slavery.9001.d
		scope:option_4.county = { upgrade_slave_population_effect = yes }
	}

	option = {
		trigger = { exists = scope:option_5 }
		name = agot_slavery.9001.e
		scope:option_5.county = { upgrade_slave_population_effect = yes }
	}

	option = {
		trigger = { exists = scope:option_6 }
		name = agot_slavery.9001.f
		scope:option_6.county = { upgrade_slave_population_effect = yes }
	}

	after = {
		if = {
			limit = {
				has_character_flag = double_slave_upgrade
			}
			remove_character_flag = double_slave_upgrade
			if = {
				limit = { agot_can_upgrade_any_slave_population_trigger = yes }
				trigger_event = agot_slavery.9001
			}
		}
	}
}

#Freed slaves join you after successful war to free slaves
agot_slavery.9002 = {
	hidden = yes

	immediate = {
		create_skilled_freed_slave_effect = { LIBERATOR = root SLAVEOWNER = scope:slaveowner }
		scope:freedman = { save_scope_as = freedman_1 }
		create_skilled_freed_slave_effect = { LIBERATOR = root SLAVEOWNER = scope:slaveowner }
		scope:freedman = { save_scope_as = freedman_2 }
		random = {
			chance = 50
			create_skilled_freed_slave_effect = { LIBERATOR = root SLAVEOWNER = scope:slaveowner }
			scope:freedman = { save_scope_as = freedman_3 }
		}
		random = {
			chance = 50
			create_skilled_freed_slave_effect = { LIBERATOR = root SLAVEOWNER = scope:slaveowner }
			scope:freedman = { save_scope_as = freedman_4 }
		}
		trigger_event = agot_slavery.9003
	}
}

agot_slavery.9003 = {
	type = character_event
	title = agot_slavery.9003.t
	desc = agot_slavery.9003.desc

	immediate = {
		scope:freedman_1 ?= { free_slave_history_effect = { LIBERATOR = root SLAVEOWNER = scope:slaveowner } }
		scope:freedman_2 ?= { free_slave_history_effect = { LIBERATOR = root SLAVEOWNER = scope:slaveowner } }
		scope:freedman_3 ?= { free_slave_history_effect = { LIBERATOR = root SLAVEOWNER = scope:slaveowner } }
		scope:freedman_4 ?= { free_slave_history_effect = { LIBERATOR = root SLAVEOWNER = scope:slaveowner } }
	}

	theme = prison
	override_background = { reference = throne_room }
	right_portrait = {
		character = root
		animation = personality_honorable
	}
	left_portrait = {
		character = scope:freedman_1
		animation = admiration
	}
	lower_left_portrait = {
		character = scope:freedman_2
	}
	lower_center_portrait = {
		character = scope:freedman_4
	}
	lower_right_portrait = {
		character = scope:freedman_3
	}

	option = { # Yes
		name = agot_slavery.9003.a
		add_courtier ?= scope:freedman_1
		add_courtier ?= scope:freedman_2
		if = {
			limit = { exists = scope:freedman_3 }
			add_courtier ?= scope:freedman_3
		}
		if = {
			limit = { exists = scope:freedman_4 }
			add_courtier ?= scope:freedman_4
		}
	}

	option = { # Dismiss them
		name = agot_slavery.9003.b
	}
}