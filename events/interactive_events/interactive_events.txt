namespace = interactive
interactive.0001 = {
	title = interactive.0001.title
	desc = interactive.0001.desc
	theme = war
	left_portrait = scope:defender
	right_portrait = scope:attacker
	#immediate = {
	#	hidden_effect = {
	#		scope:war = {
	#			remove_participant = prev
	#		}
	#	}
	#}
	option = {
		name = interactive.0001.a
		save_scope_as = recipient
		if = {
			limit = {
				is_vassal_or_below_of = scope:attacker
			}
			scope:war = {
				hidden_effect = {
					set_called_to = scope:recipient
				}
				add_attacker = prev
			}
			scope:attacker = {
				add_opinion = {
					modifier = grateful_opinion
					target = scope:recipient
					opinion = 10
				}
			}
		}
		else_if = {
			limit = {
				is_vassal_or_below_of = scope:defender
			}
			scope:war = {
				hidden_effect = {
					set_called_to = scope:recipient
				}
				add_defender = prev
			}
			scope:defender = {
				add_opinion = {
					modifier = grateful_opinion
					target = scope:recipient
					opinion = 10
				}
			}
		}
	}
	option = {
		name = interactive.0001.b
		save_scope_as = recipient

		if = {
			limit = {
				is_vassal_or_below_of = scope:attacker
				has_game_rule = bannermen_mode_enabled
			}
			scope:attacker = {
				add_opinion = {
					modifier = miv_oathbreaker
					target = scope:recipient
				}
			}

			hidden_effect = {
				scope:recipient = {
					send_interface_toast = {
						type = msg_war_oathbreaker
						title = miv_oathbreaker_bannermen_defects

						left_icon = scope:recipient

						custom_description_no_bullet = {
							text = interactive_oathbreaker_bannermen_notification_text
						}
					}
				}
			}
		}
		else_if = {
			limit = {
				is_vassal_or_below_of = scope:defender
				has_game_rule = bannermen_mode_enabled
			}
			scope:defender = {
				add_opinion = {
					modifier = miv_oathbreaker
					target = scope:recipient
				}
			}

			hidden_effect = {
				scope:recipient = {
					send_interface_toast = {
						type = msg_war_oathbreaker
						title = miv_oathbreaker_bannermen_defects

						left_icon = scope:recipient

						custom_description_no_bullet = {
							text = interactive_oathbreaker_bannermen_notification_text
						}
					}
				}
			}
		}
	}
	option = {
		name = interactive.0001.c
		save_scope_as = recipient
		if = {
			limit = {
				is_vassal_or_below_of = scope:attacker
			}
			scope:war = {
				hidden_effect = {
					set_called_to = scope:recipient
				}
				add_defender = prev
			}
			if = {
				limit = {
					has_game_rule = miv_oathbreakers_enabled
				}
				scope:attacker = {
					add_opinion = {
						modifier = miv_oathbreaker
						target = scope:recipient
					}
				}
				hidden_effect = {
					scope:recipient = {
						send_interface_toast = {
							type = msg_war_oathbreaker
							title = miv_oathbreaker_defects

							left_icon = scope:recipient

							custom_description_no_bullet = {
								text = interactive_oathbreaker_notification_text
							}
						}
					}
				}
			}
			else = {
				scope:attacker = {
					add_opinion = {
						modifier = betrayed_me_opinion
						target = scope:recipient
						opinion = -25
					}
				}
			}
			scope:defender = {
				add_opinion = {
					modifier = grateful_opinion
					target = scope:recipient
					opinion = 25
				}
			}
		}
		else_if = {
			limit = {
				is_vassal_or_below_of = scope:defender
			}
			scope:war = {
				hidden_effect = {
					set_called_to = scope:recipient
				}
				add_attacker = prev
			}
			if = {
				limit = {
					has_game_rule = miv_oathbreakers_enabled
				}
				scope:defender = {
					add_opinion = {
						modifier = miv_oathbreaker
						target = scope:recipient
					}
				}
				hidden_effect = {
					scope:recipient = {
						send_interface_toast = {
							type = msg_war_oathbreaker
							title = miv_oathbreaker_defects

							left_icon = scope:recipient

							custom_description_no_bullet = {
								text = interactive_oathbreaker_notification_text
							}
						}
					}
				}
			}
			else = {
				scope:defender = {
					add_opinion = {
						modifier = betrayed_me_opinion
						target = scope:recipient
						opinion = -25
					}
				}
			}
			scope:attacker = {
				add_opinion = {
					modifier = grateful_opinion
					target = scope:recipient
					opinion = 25
				}
			}
			if = {
				limit = {
					exists = scope:attacker.joined_faction
					scope:attacker = { is_vassal_of = scope:defender }
				}
				join_faction_skip_check = scope:attacker.joined_faction
			}
		}
	}
}

interactive.0002 = {
	type = letter_event
	opening = {
		desc = call_ally.0100.opening
	}
	desc = call_ally.0100.desc
	sender = {
		character = scope:recipient
		animation = anger
	}

	option = {
		name = EXCELLENT
	}
}

interactive.0003 = {
	type = letter_event
	sender = scope:actor
	opening = vassal_interaction.0001.opening
	desc = vassal_interaction.0001.desc
	
	immediate = {
		scope:target = {
			primary_defender = {
				save_scope_as = defender
			}
		}
			
		save_scope_value_as = {
			name = response
			value = flag:gold
		}
	}

	option = { #Accept
		name = vassal_interaction.0001.a
		show_as_tooltip = {
			scope:target = {
				end_war = white_peace
			}
			scope:actor = {
				add_opinion = {
					target = root
					modifier = pleased_opinion
					opinion = low_positive_opinion
				}
			}
		}
		scope:actor = {
			trigger_event = {
				id = vassal_interaction.0002
				days = { 2 5 }
			}
		}
		ai_chance = {
			base = 0
			modifier = {
				add = 100
				scope:response = flag:accept
			}
		}
	}

	option = { #Request a favor
		name = vassal_interaction.0001.b
		trigger = {
			can_add_hook = {
				target = scope:actor
				type = favor_hook
			}
		}
		custom_tooltip = vassal_interaction.0001.request_favor_tt
		show_as_tooltip = {
			random_list = {
				1 = {
					desc = vassal_interaction.0001.accept
					show_chance = no
					scope:target = {
						end_war = white_peace
					}
					add_hook = {
						target = scope:actor
						type = favor_hook
					}
				}
				1 = {
					desc = vassal_interaction.0001.decline
					show_chance = no
					add_prestige = medium_prestige_loss
				}
			}
		}
		scope:actor = {
			trigger_event = {
				id = vassal_interaction.0003
				days = { 2 5 }
			}
		}
		ai_chance = {
			base = 0
			modifier = {
				add = 100
				scope:response = flag:favor
			}
		}
	}
	
	option = { #Request gold
		name = vassal_interaction.0001.c
		custom_tooltip = vassal_interaction.0001.request_gold_tt
		show_as_tooltip = {
			random_list = {
				1 = {
					desc = vassal_interaction.0001.accept
					show_chance = no
					scope:target = {
						end_war = white_peace
					}
					scope:actor = {
						pay_short_term_gold = {
							target = root
							gold = scope:recipient.stop_war_attacker_bribe_size
						}
					}
				}
				1 = {
					desc = vassal_interaction.0001.decline
					show_chance = no
					add_prestige = medium_prestige_loss
				}
			}
		}
		scope:actor = {
			trigger_event = {
				id = vassal_interaction.0004
				days = { 2 5 }
			}
		}
		ai_chance = {
			base = 0
			modifier = {
				add = 100
				scope:response = flag:gold
			}
		}
	}
	
	option = { #Refuse
		name = vassal_interaction.0001.d
		trigger = {
			NOT = { has_usable_hook = scope:actor }
		}
		show_as_tooltip = {
			scope:actor = {
				add_opinion = {
					target = root
					modifier = refusal_opinion
					opinion = low_negative_opinion
				}
			}
		}
		scope:actor = {
			trigger_event = {
				id = vassal_interaction.0005
				days = { 2 5 }
			}
		}
		ai_chance = {
			base = 0
			modifier = {
				add = 100
				scope:response = flag:refuse
			}
		}
	}

	option = { #Refuse - you have a hook!
		name = vassal_interaction.0001.e
		trigger = {
			has_usable_hook = scope:actor
		}
		show_as_tooltip = {
			use_hook = scope:actor
		}
		save_scope_value_as = {
			name = vassal_used_hook
			value = yes
		}
		scope:actor = {
			trigger_event = {
				id = vassal_interaction.0005
				days = { 2 5 }
			}
		}
		ai_chance = {
			base = 0
			modifier = {
				add = 100
				scope:response = flag:refuse
			}
		}
	}
}

interactive.0004 = {
	hidden = yes

	immediate = {
		save_temporary_scope_as = liege

		scope:liege = {
			every_vassal = {
				limit = {
					OR = {
						AND = {
							scope:liege = { highest_held_title_tier < tier_empire }
							highest_held_title_tier >= tier_county
						}
						highest_held_title_tier >= tier_duchy
					}
					max_military_strength > 200
					is_landed = yes
					is_ai = yes
				}
				save_temporary_scope_as = vassal
				if = {
					limit = {
						opinion = {
							target = scope:liege
							value >= -25
						}
						NOT = { is_at_war_with = scope:liege }
						NOT = {
							scope:liege = {
								has_opinion_modifier = {
									modifier = miv_oathbreaker
									target = scope:vassal
								}
							}
						}
					}
					add_to_list = interactive_accept
				}
				else_if = {
					limit = {
						NOT = { is_at_war_with = scope:liege }
						NOT = {
							scope:liege = {
								has_opinion_modifier = {
									modifier = miv_oathbreaker
									target = scope:vassal
								}
							}
						}
					}
					add_to_list = interactive_refuse
				}
			}

			every_character_war = {
				save_temporary_scope_as = war
				if = {
					limit = {
						scope:war = { any_war_attacker = { this = scope:liege } }
						OR = {
							scope:war = { primary_attacker = scope:liege }
							scope:liege = { is_ai = no }
							AND = {
								OR = {
									has_game_rule = bannermen_extended_mode_2_enabled
									has_global_variable = AGOT_is_loaded
								}
								scope:liege = { highest_held_title_tier >= tier_kingdom }
							}
							AND = {
								has_game_rule = bannermen_extended_mode_3_enabled
								scope:liege = { highest_held_title_tier >= tier_duchy }
							}
						}
						NAND = {
							scope:war = {
								primary_attacker = {
									is_vassal_of = scope:war.primary_defender
								}
								primary_defender = {
									this = scope:liege
								}
							}
						}
					}
					every_in_list = {
						list = interactive_accept
						save_temporary_scope_as = vassal
						if = {
							limit = {
								scope:vassal = { NOT = { is_at_war_with = scope:war.primary_defender } }
							}
							scope:war = { add_attacker = scope:vassal }
							scope:vassal = {
								add_opinion = {
									target = liege
									modifier = war_exhaustion_vassal_opinion
									opinion = -10
								}	
							}
						}
					}
				}
				else_if = {
					limit = {
						scope:war = { any_war_defender = { this = scope:liege } }
						OR = {
							scope:war = { primary_defender = scope:liege }
							scope:liege = { is_ai = no }
							AND = {
								OR = {
									has_game_rule = bannermen_extended_mode_2_enabled
									has_global_variable = AGOT_is_loaded
								}
								scope:liege = { highest_held_title_tier >= tier_kingdom }
							}
							AND = {
								has_game_rule = bannermen_extended_mode_3_enabled
								scope:liege = { highest_held_title_tier >= tier_duchy }
							}
						}
						NAND = {
							scope:war = {
								primary_attacker = {
									is_vassal_of = scope:war.primary_defender
								}
								primary_defender = {
									this = scope:liege
								}
							}
						}
					}
					every_in_list = {
						list = interactive_accept
						save_temporary_scope_as = vassal
						if = {
							limit = {
								scope:vassal = { NOT = { is_at_war_with = scope:war.primary_attacker } }
							}
							scope:war = { add_defender = scope:vassal }
							scope:vassal = {
								add_opinion = {
									target = liege
									modifier = war_exhaustion_vassal_opinion
									opinion = -5
								}	
							}
						}
					}
				}
			}

			every_in_list = {
				list = interactive_refuse
				save_temporary_scope_as = vassal
				scope:liege = {
					add_opinion = {
						target = scope:vassal
						modifier = miv_oathbreaker
					}

					send_interface_toast = {
						type = msg_war_oathbreaker
						title = miv_oathbreaker_bannermen_defects
	
						left_icon = scope:vassal
	
						custom_description_no_bullet = {
							text = interactive_oathbreaker_bannermen_notification_text
						}
					}
				}
			}
		}
	}
}
